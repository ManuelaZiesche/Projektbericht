= Betriebsdokumentation

:!table-caption:

== Backup unter Linux

.Voraussetzungen
* der Admin muss über root Rechte verfügen
* ein Termina muss geöffnet worden sein

=== Backup einrichten

[cols="1,4,6"]
|===
| Schritt | Befehl | Kommentar

| 1 | `sudo -i` | Login aufrufen
| 2 | `[sudo] password: * * *`  | Passwort eingeben
|===

.*(1) Backup-Skript erstellen und abspeichern*

[cols="1,4,6"]
|===
| Schritt | Befehl | Kommentar

| 3 | `cd /bar` | Zu einem beliebigen Verzeichnis wechseln
| 4 | `nano db-backup-skript` | Backup Skript mit einem beliebigen Editor erstellen und abspeichern
|===

.db-backup-skript
[source, bash]
----
#!/bin/bash
DIR=/pfad/zur/datenbank
BACKUPDIR=/gewünschter/speicherort/für/das/backup
WEEK=`date +"%W"`
OLDWEEK=`date -d "-3 week" +"%W"`

#Generiert das Backup
sqlite3 ${DIR}/db.sqlite3 .dump > ${BACKUPDIR}/db-backup-kw${WEEK}.txt

#Löscht Backups, die älter als 3 Wochen alt sind
rm ${BACKUPDIR}/db-backup-kw${OLDWEEK}.txt
----

.*(2) CronJob erstellen und speichern*

[cols="1,4,6"]
|===
| Schritt | Befehl | Kommentar

| 5 | `cd /etc` | etc-Verzeichnis aufrufen
| 6 | `/nano crontab` | crontab mit beliebigen Editor öffnen, CronJob am Ende der Datei einfügen und speichern
|===

.CronJob
[source, bash]
----
#Backup-Skript "db-backup-skript" wird jeden Sonntag 00:15 aufgerufen
15 0   * * sun   user    test -x /bin/db-backup-skript && /bin/db-backup-skript- >/dev/null 2>&1
----

=== Wiederherstellung der Datenbank aus einem Backup

[cols="1,5,5"]
|===
| Schritt | Befehl | Kommentar

| 1 | `cd /backup` | Verzeichnis aufrufen, in der das Backup gespeichert wurde
| 2 | `sqlite3 foo.sqlite3 < db-backup-kwXX.txt` | XX durch die jeweilige Kalenderwoche des backups ersetzten, aus der die neue Datenbank "foo" generiert werden soll
| 3 | `mv /backup/foo.sqlite3 /baz/` | Die Datenbank "foo" kann nun in einen beliebigen Ordner verschoben werden
|===



